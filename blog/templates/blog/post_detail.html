{% extends 'blog/base.html' %}
{% block title %}{{ post.titulo }} ‚Äì MeuBlog{% endblock %}

{% block content %}
  <article class="post-detail">
    <h2>{{ post.titulo }}</h2>
    <p style="font-size: 0.9rem; color: #666;">
      Por <strong>{{ post.autor }}</strong> em {{ post.criado_em|date:"d M Y" }}
      {% if post.categoria %}
        | <span style="color: #d62828;">üìÇ {{ post.categoria.nome }}</span>
      {% endif %}
    </p>

    {% if post.imagem %}
      <img src="{{ post.imagem.url }}" alt="Imagem do post"
           style="width: 25%; height: auto; float: right; margin-left: 1em; border-radius: 5px;">
    {% endif %}

    <div style="margin-top: 1.5em;">
      {{ post.conteudo|linebreaks }}
    </div>

    <!-- SISTEMA DE M√öLTIPLAS REA√á√ïES -->
    <div id="reacao-container" style="margin: 2em 0; padding: 1.5em; background-color: #f8f9fa; border-radius: 8px;">
      <h4 style="margin-top: 0; color: #003f88;">‚≠ê Rea√ß√µes ({{ total_reacoes }})</h4>
      
      {% if user.is_authenticated %}
        <div class="reacoes-botoes">
          <!-- BOT√ÉO: Curtir (Polegar para cima) -->
          <button class="btn-reacao {% if reacao_usuario.tipo_reacao == 'curtir' %}ativo{% endif %}" 
                  onclick="enviarReacao('{{ post.slug }}', 'curtir', this)" 
                  title="Curtir">
            üëç Curtir <span class="contador-reacao">{{ reacoes_dict.curtir|default:0 }}</span>
          </button>

          <!-- BOT√ÉO: Amei (Cora√ß√£o) -->
          <button class="btn-reacao {% if reacao_usuario.tipo_reacao == 'amei' %}ativo{% endif %}" 
                  onclick="enviarReacao('{{ post.slug }}', 'amei', this)" 
                  title="Amei">
            ‚ù§Ô∏è Amei <span class="contador-reacao">{{ reacoes_dict.amei|default:0 }}</span>
          </button>

          <!-- BOT√ÉO: Engra√ßado (Rindo) -->
          <button class="btn-reacao {% if reacao_usuario.tipo_reacao == 'engra√ßado' %}ativo{% endif %}" 
                  onclick="enviarReacao('{{ post.slug }}', 'engra√ßado', this)" 
                  title="Engra√ßado">
            üòÇ Engra√ßado <span class="contador-reacao">{{ reacoes_dict.engra√ßado|default:0 }}</span>
          </button>

          <!-- BOT√ÉO: N√£o gostei (Polegar para baixo) -->
          <button class="btn-reacao {% if reacao_usuario.tipo_reacao == 'n√£o_gostei' %}ativo{% endif %}" 
                  onclick="enviarReacao('{{ post.slug }}', 'n√£o_gostei', this)" 
                  title="N√£o gostei">
            üëé N√£o gostei <span class="contador-reacao">{{ reacoes_dict.n√£o_gostei|default:0 }}</span>
          </button>
        </div>
      {% else %}
        <p style="padding: 1em; background-color: #fff3cd; border-radius: 5px; margin: 0;">
          <a href="{% url 'login' %}">Fa√ßa login</a> para reagir aos posts.
        </p>
      {% endif %}
    </div>

    <hr style="margin-top: 2em;">

    <!-- A√á√ïES DO AUTOR -->
    {% if user == post.autor %}
      <div style="margin-bottom: 2em;">
        <a href="{% url 'post_edit' slug=post.slug %}" class="text-blue-500">‚úèÔ∏è Editar</a> |
        <a href="{% url 'post_delete' slug=post.slug %}" class="text-red-500">üóëÔ∏è Excluir</a>
      </div>
    {% endif %}
  </article>

  <!-- SE√á√ÉO DE COMENT√ÅRIOS -->
  <section class="comentarios-section">
    <h3>üí¨ Coment√°rios ({{ comentarios.count }})</h3>
    
    <!-- FORMUL√ÅRIO PARA NOVO COMENT√ÅRIO -->
    {% if user.is_authenticated %}
      <form method="post" class="form-comentario">
        {% csrf_token %}
        <textarea name="conteudo" rows="3" placeholder="Deixe seu coment√°rio..." required maxlength="1000"></textarea>
        <button type="submit">Comentar</button>
      </form>
    {% else %}
      <p style="padding: 1em; background-color: #fff3cd; border-radius: 5px;">
        <a href="{% url 'login' %}">Fa√ßa login</a> para comentar.
      </p>
    {% endif %}

    <!-- LISTA DE COMENT√ÅRIOS -->
    <div class="comentarios-lista">
      {% for comentario in comentarios %}
        <div class="comentario">
          <div class="comentario-header">
            <strong>{{ comentario.autor.username }}</strong>
            <span class="comentario-data">
              {{ comentario.criado_em|date:"d/m/Y H:i" }}
              {% if comentario.atualizado_em > comentario.criado_em %}
                (editado)
              {% endif %}
            </span>
            
            <div class="comentario-acoes">
              {% if user == comentario.autor %}
                <a href="{% url 'editar_comentario' comentario.id %}" 
                   class="comentario-editar">
                  ‚úèÔ∏è Editar
                </a>
              {% endif %}
              
              {% if user == comentario.autor or user.perfil.is_admin %}
                <a href="{% url 'excluir_comentario' comentario.id %}" 
                   class="comentario-excluir" 
                   onclick="return confirm('Tem certeza que deseja excluir este coment√°rio?')">
                  üóëÔ∏è Excluir
                </a>
              {% endif %}
            </div>
          </div>
          <p class="comentario-conteudo">{{ comentario.conteudo }}</p>
        </div>
      {% empty %}
        <p class="sem-comentarios">Nenhum coment√°rio ainda. Seja o primeiro!</p>
      {% endfor %}
    </div>
  </section>
{% endblock %}

{% block extra_scripts %}
<script>
function enviarReacao(slug, tipoReacao, botao) {
  const formData = new FormData();
  formData.append('tipo_reacao', tipoReacao);
  formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));

  // Desabilita o bot√£o enquanto processa
  botao.disabled = true;

  fetch(`/post/${slug}/curtir/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCookie('csrftoken'),
    },
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.sucesso) {
      // Remove classe 'ativo' de todos os bot√µes de rea√ß√£o
      document.querySelectorAll('.btn-reacao').forEach(btn => {
        btn.classList.remove('ativo');
      });

      // Se uma rea√ß√£o foi adicionada, adiciona classe ao bot√£o clicado
      if (data.reacao_adicionada) {
        botao.classList.add('ativo');
      }

      // Recarrega a p√°gina para atualizar contadores
      location.reload();
    } else {
      alert('Erro ao processar rea√ß√£o: ' + data.erro);
      botao.disabled = false;
    }
  })
  .catch(error => {
    console.error('Erro:', error);
    alert('Erro ao processar rea√ß√£o. Tente novamente.');
    botao.disabled = false;
  });
}

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>
{% endblock %}

{% block extra_css %}
<style>
  /* Estilos para o container de rea√ß√µes */
  #reacao-container h4 {
    margin-top: 0;
    color: #003f88;
  }

  /* Container de bot√µes de rea√ß√£o */
  .reacoes-botoes {
    display: flex;
    flex-wrap: wrap;
    gap: 0.8em;
    margin-top: 1em;
  }

  /* Bot√µes de rea√ß√£o */
  .btn-reacao {
    display: flex;
    align-items: center;
    gap: 0.4em;
    padding: 0.6em 1.2em;
    border: 2px solid #ddd;
    background-color: white;
    color: #333;
    font-weight: bold;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.95rem;
  }

  .btn-reacao:hover {
    border-color: #003f88;
    background-color: #f0f6ff;
    transform: translateY(-2px);
  }

  /* Bot√£o ativo (usu√°rio j√° reagiu) */
  .btn-reacao.ativo {
    background-color: #d62828;
    color: white;
    border-color: #a4161a;
  }

  .btn-reacao.ativo:hover {
    background-color: #a4161a;
    border-color: #a4161a;
  }

  .btn-reacao:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  /* Contador dentro do bot√£o */
  .contador-reacao {
    background-color: rgba(0, 0, 0, 0.1);
    padding: 0.2em 0.5em;
    border-radius: 10px;
    font-size: 0.85rem;
    font-weight: bold;
  }

  .btn-reacao.ativo .contador-reacao {
    background-color: rgba(255, 255, 255, 0.3);
  }

  /* Responsivo */
  @media (max-width: 768px) {
    .reacoes-botoes {
      flex-direction: column;
    }

    .btn-reacao {
      width: 100%;
      justify-content: center;
    }
  }
</style>
{% endblock %}